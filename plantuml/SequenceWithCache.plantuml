@startuml
actor User
participant Gateway
participant PEP
participant Attrs as AttributeResolvers
participant Cache
participant PDP as OPA
User -> Gateway: HTTP request (JWT)
Gateway -> PEP: authorize(request)
PEP -> Attrs: resolve attributes
Attrs --> PEP: {subject,resource,env}
PEP -> Cache: get(key=hash(input))
alt hit
 Cache --> PEP: ALLOW/DENY
else miss
 PEP -> PDP: POST /v1/data/app/allow {input}
 PDP --> PEP: {result: {allow:true}}
 PEP -> Cache: put(key, decision, ttl)
end
PEP --> Gateway: proceed/deny
@enduml
